{% extends 'base.html' %}

{% block content %}

<h1>Rule details</h1>

<script>
    let counter = 0
    function deleteRow(target) {
        $(target).closest("tr").remove();
    }

    function loadCriteria(criteria) {
        criteria.forEach(criteria => {
            document.getElementById("addrow").click();

            let nameInputs = document.querySelectorAll('input[name*=name]')
            nameInputs[nameInputs.length - 1].value = criteria.criterion;

            let weightSelects = document.querySelectorAll('select[name*=multiplier]')
            weightSelects[weightSelects.length - 1].value = criteria.multiplier;

            let noteInputs = document.querySelectorAll('input[name*=note]')
            noteInputs[noteInputs.length - 1].value = criteria.note;
        })
    }

    /* insert new row into criteria_table */
    function insertRow() {
        // ToDo: consider refactoring using JS createElement and appendChild
        let newRow = document.createElement("tr");
        let cols = `<td><input type="text" class="form-control" required name="name${counter}"/></td>`;
        counter += 1
        cols += `
                <td>
                    <select name="multiplier${counter}" class="custom-select" class="form-control col-sm-4">
                        <option value="5" selected>5</option>
                        <option value="4">4</option>
                        <option value="3">3</option>
                        <option value="2">2</option>
                        <option value="1">1</option>
                    </select>
                </td>
            `;
        cols += `<td><input type="text" class="form-control" name="note${counter}"/></td>`;

        cols += '<td><ion-icon name="trash-outline" onclick="deleteRow(this)" size="large" class="delete-row btn btn-md btn-light" ></ion-icon></td>';

        newRow.innerHTML = cols;
        document.querySelector('#criteria_table tbody').appendChild(newRow)
        document.querySelector('#criteria_table tbody').lastChild.querySelector('[name*=name]').focus()
    }
</script>

<form action="{{url_for('rules')}}" method="post">
    <div class="container">
        <!-- hidden field for storing rule_ids when modifying rules-->
        <input id="rule_id" name="rule_id" type="hidden" value="">
        <input type="text" name="rule_name" id="rule_name" class="form-control" placeholder="rule name" required />

        <table id="criteria_table" class="table table-hover criteria">
            <thead class="thead-light">
                <tr>
                    <th>Criterion</th>
                    <th>Multiplier</th>
                    <th>Note</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="5">
                        <input type="button" class="btn btn-lg btn-block btn-info" id="addrow" value="Add Row"
                            onclick="insertRow()" />
                    </td>
                </tr>
                <tr>
                    <td colspan="5" style="text-align: right;">
                        <button class="btn btn-primary btn-lg" data-test="submit-button" type="submit">Submit</button>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>

    {% if rule %}
    <!-- modifying existing rule -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelector('#rule_name').value = '{{ rule.rule_name }}';
            document.querySelector('#rule_id').value = '{{ rule._id }}';
            loadCriteria({{ rule.criteria | tojson }});
        });
        document.querySelector('form').setAttribute('action', `{{url_for('rules')}}/{{ rule._id }}`)
    </script>
    {% else %}
    <!-- creating new rule -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("addrow").click();
        });
    </script>

    {% endif %}

</form>

{% endblock content %}